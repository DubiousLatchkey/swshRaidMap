<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Raid Map - Composite View</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="styles/spritesheet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            margin: 5px 0 5px 0;
            font-size: 28px;
            padding: 10px 0;
        }
        
        .map-container {
            height: calc(100vh - 60px);
            width: 100%;
            margin: 0;
            position: relative;
        }
        
        .map {
            height: 100%;
            width: 100%;
            position: relative;
            background-color: #6bc6cd;
        }
        
        /* Floating Filter Window */
        .floating-filter-window {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 300px;
            max-width: 350px;
            transition: all 0.3s ease;
        }
        
        .filter-window-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 12px 15px;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .filter-window-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }
        
        .filter-window-toggle {
            font-size: 18px;
            color: #666;
            transition: transform 0.3s ease;
        }
        
        .filter-window-toggle.collapsed {
            transform: rotate(180deg);
        }
        
        .filter-window-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .filter-window-content.collapsed {
            max-height: 0;
            padding: 0 15px;
            overflow: hidden;
        }
        
        .filter-section {
            margin-bottom: 20px;
        }
        
        .filter-section:last-child {
            margin-bottom: 0;
        }
        
        .filter-section label {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }
        
        .star-filter-container {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .star-button {
            padding: 6px 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            min-width: 50px;
            text-align: center;
        }
        
        .star-button:hover {
            border-color: #007cba;
            background-color: #f0f8ff;
        }
        
        .star-button.active {
            border-color: #007cba;
            background-color: #007cba;
            color: white;
        }
        
        .star-icon {
            color: #ffa500;
            font-weight: bold;
            text-shadow: 0 0 1px rgba(0,0,0,0.3);
        }
        
        .star-button.active .star-icon {
            color: #fff;
            text-shadow: 0 0 1px rgba(0,0,0,0.5);
        }
        
        .clear-stars-button {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
            cursor: pointer;
            color: #666;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        
        .clear-stars-button:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        
        .filter-status {
            margin-top: 15px;
            padding: 10px;
            font-size: 12px;
            color: #666;
            font-style: italic;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }
        
        .area-labels {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            pointer-events: none;
        }
        
        .area-label {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 5px;
            display: block;
        }

        .pokemon-sprite-container {
            display: inline-block;
            margin: 0;
            text-align: center;
            min-width: 0;
            width: 100%;
        }
        
        .pokemon-sprite {
            display: block;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            margin: 0 auto 2px auto;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .pokemon-sprite:hover {
            border-color: #007cba;
            background-color: #e7f3ff;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 124, 186, 0.3);
        }
        
        .pokemon-sprite.sword-exclusive {
            background-color: #0075BE;
            border-color: #005a9a;
        }
        
        .pokemon-sprite.sword-exclusive:hover {
            background-color: #0084d1;
            border-color: #0075BE;
        }
        
        .pokemon-sprite.shield-exclusive {
            background-color: #C62D42;
            border-color: #a02435;
        }
        
        .pokemon-sprite.shield-exclusive:hover {
            background-color: #d63851;
            border-color: #C62D42;
        }
        
        .rank-display {
            font-size: 10px;
            font-weight: bold;
            color: #333;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 3px;
            padding: 1px 3px;
            margin-top: 1px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            min-height: 12px;
            line-height: 12px;
            transition: all 0.2s ease;
        }
        
        .rank-display.filter-match {
            background-color: #22c55e;
            color: white;
            box-shadow: 0 2px 4px rgba(34, 197, 94, 0.4);
            font-weight: bold;
        }
        
        .popup-section {
            margin-bottom: 10px;
        }
        
        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            color: #000;
            background-color: #e9ecef;
        }
        
        .modal-scroll-container {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
            gap: 8px;
            margin: 15px 0;
            max-width: 900px;
            justify-items: center;
            padding: 0 4px;
        }
        
        /* Pokemon search input styles */
        .pokemon-search-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .pokemon-search-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            box-sizing: border-box;
        }
        
        .pokemon-search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10001;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .pokemon-search-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .pokemon-search-item:hover {
            background-color: #f0f0f0;
        }
        
        .pokemon-search-item:last-child {
            border-bottom: none;
        }
        
        /* Pokemon detail modal styles */
        .pokemon-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 15000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .pokemon-detail-content {
            background: white;
            border-radius: 8px;
            max-width: 90vw;
            max-height: 80vh;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            min-width: 300px;
        }
        
        .pokemon-detail-sprite {
            width: 96px;
            height: 96px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .pokemon-detail-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .pokemon-detail-section {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #007cba;
        }
        
        .pokemon-detail-section h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 14px;
            font-weight: bold;
        }
        
        .pokemon-detail-section p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }
        
        .clickable-sprite {
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        
        .clickable-sprite:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .map-container {
                height: calc(100vh - 50px);
            }
            
            .floating-filter-window {
                min-width: 280px;
                max-width: 300px;
                bottom: 15px;
                left: 15px;
            }
            
            .filter-window-content {
                max-height: 300px;
            }
            
            .pokemon-grid {
                grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
                gap: 6px;
                padding: 0 8px;
            }
            
            .pokemon-detail-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <h1>Pokemon Raid Den Locations</h1>
    
    <div class="map-container">
        <div id="compositeMap" class="map"></div>
        
        <!-- Floating Filter Window -->
        <div class="floating-filter-window">
            <div class="filter-window-header" onclick="toggleFilterWindow()">
                <div class="filter-window-title">Filters</div>
                <div class="filter-window-toggle" id="filterToggle">▼</div>
            </div>
            <div class="filter-window-content" id="filterContent">
                <div class="filter-section">
                    <label for="pokemonSearch">Filter by Pokemon:</label>
                    <div class="pokemon-search-container">
                        <input type="text" id="pokemonSearch" class="pokemon-search-input" placeholder="Type Pokemon name...">
                        <div id="pokemonDropdown" class="pokemon-search-dropdown"></div>
                    </div>
                </div>
                
                <div class="filter-section">
                    <label>Filter by Stars:</label>
                    <div class="star-filter-container">
                        <button class="star-button" data-star="1" onclick="toggleStarFilter(1)">
                            <span class="star-icon">★</span>
                        </button>
                        <button class="star-button" data-star="2" onclick="toggleStarFilter(2)">
                            <span class="star-icon">★★</span>
                        </button>
                        <button class="star-button" data-star="3" onclick="toggleStarFilter(3)">
                            <span class="star-icon">★★★</span>
                        </button>
                        <button class="star-button" data-star="4" onclick="toggleStarFilter(4)">
                            <span class="star-icon">★★★★</span>
                        </button>
                        <button class="star-button" data-star="5" onclick="toggleStarFilter(5)">
                            <span class="star-icon">★★★★★</span>
                        </button>
                        <button class="clear-stars-button" onclick="clearStarFilters()">Clear</button>
                    </div>
                </div>
                
                <div id="filterStatus" class="filter-status" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal for den information -->
    <div id="denModal" class="modal-overlay">
        <div class="modal-content">
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Modal for Pokemon details -->
    <div id="pokemonDetailModal" class="pokemon-detail-modal">
        <div class="pokemon-detail-content">
            <div id="pokemonDetailContent"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Composite layout configuration
        const COMPOSITE_LAYOUT = {
            "composite": {
                "width": 2759,
                "height": 4559
            },
            "wild_area": {
                "x": 444,
                "y": 0,
                "width": 1032,
                "height": 2399
            },
            "isle_of_armor": {
                "x": 1576,
                "y": 0,
                "width": 1183,
                "height": 1183
            },
            "crown_tundra": {
                "x": 0,
                "y": 2499,
                "width": 1920,
                "height": 2060
            },
            "spacing": 100
        };

        // Load data
        let denData = [];
        let raidTables = [];
        let pokemonNames = {};
        let gmaxMapping = {};
        let dataLoaded = 0;
        
        function checkDataLoaded() {
            if (dataLoaded === 4) {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        setTimeout(() => {
                            initializeCompositeMap();
                            setupPokemonFilter();
                        }, 100);
                    });
                } else {
                    setTimeout(() => {
                        initializeCompositeMap();
                        setupPokemonFilter();
                    }, 100);
                }
            }
        }
        
        // Load all data files
        fetch('data/den_locations.json')
            .then(response => response.json())
            .then(data => {
                denData = data;
                dataLoaded++;
                checkDataLoaded();
            })
            .catch(error => {
                console.error('Error loading den data:', error);
                denData = [];
                dataLoaded++;
                checkDataLoaded();
            });
            
        fetch('data/raid_tables.json')
            .then(response => response.json())
            .then(data => {
                raidTables = data;
                dataLoaded++;
                checkDataLoaded();
            })
            .catch(error => {
                console.error('Error loading raid tables:', error);
                raidTables = [];
                dataLoaded++;
                checkDataLoaded();
            });
            
        fetch('data/pokemon_names.json')
            .then(response => response.json())
            .then(data => {
                pokemonNames = data;
                dataLoaded++;
                checkDataLoaded();
            })
            .catch(error => {
                console.error('Error loading pokemon names:', error);
                pokemonNames = {};
                dataLoaded++;
                checkDataLoaded();
            });
            
        fetch('data/gmax_mapping.json')
            .then(response => response.json())
            .then(data => {
                gmaxMapping = data;
                dataLoaded++;
                checkDataLoaded();
            })
            .catch(error => {
                console.error('Error loading gmax mapping:', error);
                gmaxMapping = {};
                dataLoaded++;
                checkDataLoaded();
            });

        // Filter window toggle functionality
        function toggleFilterWindow() {
            const content = document.getElementById('filterContent');
            const toggle = document.getElementById('filterToggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
            }
        }

        // Coordinate transformation functions
        function transformDenCoordinates(den) {
            const location = den.location;
            const compositeHeight = COMPOSITE_LAYOUT.composite.height;
            let areaConfig, transformedX, transformedY;
            
            if (location < 17) {
                // Wild Area
                areaConfig = COMPOSITE_LAYOUT.wild_area;
                transformedX = areaConfig.x + den.MapX;
                // Convert to Leaflet coordinates: position within composite, then invert for Leaflet
                transformedY = compositeHeight - (areaConfig.y + den.MapY);
            } else if (location >= 17 && location < 32) {
                // Isle of Armor
                areaConfig = COMPOSITE_LAYOUT.isle_of_armor;
                transformedX = areaConfig.x + den.MapX;
                // Convert to Leaflet coordinates: position within composite, then invert for Leaflet
                transformedY = compositeHeight - (areaConfig.y + den.MapY);
            } else {
                // Crown Tundra
                areaConfig = COMPOSITE_LAYOUT.crown_tundra;
                transformedX = areaConfig.x + den.MapX;
                // Convert to Leaflet coordinates: position within composite, then invert for Leaflet
                transformedY = compositeHeight - (areaConfig.y + den.MapY);
            }
            
            return { x: transformedX, y: transformedY };
        }
        
        function getAreaName(location) {
            if (location < 17) return "Wild Area";
            if (location >= 17 && location < 32) return "Isle of Armor";
            return "Crown Tundra";
        }

        // Helper functions for raid data (keeping all existing functions)
        function getPokemonFromBothVersions(poolId) {
            const swordPool = raidTables.find(pool => pool.pool_id === poolId && pool.version === 1);
            const shieldPool = raidTables.find(pool => pool.pool_id === poolId && pool.version === 2);
            
            const swordPokemon = swordPool ? swordPool.pokemon.map(p => ({...p, version: 1})) : [];
            const shieldPokemon = shieldPool ? shieldPool.pokemon.map(p => ({...p, version: 2})) : [];
            
            return deduplicatePokemon(swordPokemon, shieldPokemon);
        }
        
        function deduplicatePokemon(swordPokemon, shieldPokemon) {
            const pokemonMap = new Map();
            
            function createPokemonKey(pokemon) {
                return `${pokemon.species}-${pokemon.altForm}-${pokemon.ability}-${pokemon.gender}-${pokemon.gigantamax}-${pokemon.flawlessIVs}-${pokemon.minRank}-${pokemon.maxRank}`;
            }
            
            swordPokemon.forEach(pokemon => {
                const key = createPokemonKey(pokemon);
                pokemonMap.set(key, {
                    ...pokemon,
                    versions: [1],
                    exclusiveVersion: null,
                    swordRanks: { min: pokemon.minRank, max: pokemon.maxRank },
                    shieldRanks: null,
                    swordProbabilities: pokemon.Probabilities || pokemon.probabilities,
                    shieldProbabilities: null
                });
            });
            
            shieldPokemon.forEach(pokemon => {
                const key = createPokemonKey(pokemon);
                if (pokemonMap.has(key)) {
                    const existing = pokemonMap.get(key);
                    existing.versions.push(2);
                    existing.shieldRanks = { min: pokemon.minRank, max: pokemon.maxRank };
                    existing.shieldProbabilities = pokemon.Probabilities || pokemon.probabilities;
                } else {
                    pokemonMap.set(key, {
                        ...pokemon,
                        versions: [2],
                        exclusiveVersion: 2,
                        swordRanks: null,
                        shieldRanks: { min: pokemon.minRank, max: pokemon.maxRank },
                        swordProbabilities: null,
                        shieldProbabilities: pokemon.Probabilities || pokemon.probabilities
                    });
                }
            });
            
            pokemonMap.forEach((pokemon, key) => {
                if (pokemon.versions.length === 1 && pokemon.versions[0] === 1) {
                    pokemon.exclusiveVersion = 1;
                }
            });
            
            return Array.from(pokemonMap.values()).sort((a, b) => {
                const aMaxRank = Math.max(
                    a.swordRanks ? a.swordRanks.max : -1,
                    a.shieldRanks ? a.shieldRanks.max : -1
                );
                const bMaxRank = Math.max(
                    b.swordRanks ? b.swordRanks.max : -1,
                    b.shieldRanks ? b.shieldRanks.max : -1
                );
                
                const aMinRank = Math.min(
                    a.swordRanks ? a.swordRanks.min : Infinity,
                    a.shieldRanks ? a.shieldRanks.min : Infinity
                );
                const bMinRank = Math.min(
                    b.swordRanks ? b.swordRanks.min : Infinity,
                    b.shieldRanks ? b.shieldRanks.min : Infinity
                );
                
                if (aMaxRank !== bMaxRank) {
                    return aMaxRank - bMaxRank;
                }
                if (aMinRank !== bMinRank) {
                    return aMinRank - bMinRank;
                }
                return a.species - b.species;
            });
        }
        
        // Store variables for filtering
        let allMarkers = [];
        let pokemonList = [];
        let currentFilter = '';
        let selectedStars = new Set();
        let compositeMap;
        let currentModalDen = null;
        let currentModalIndex = null;
        
        // Initialize composite map
        function initializeCompositeMap() {
            compositeMap = L.map('compositeMap', {
                crs: L.CRS.Simple,
                minZoom: -3,
                maxZoom: 2
            });
            
            const compositeWidth = COMPOSITE_LAYOUT.composite.width;
            const compositeHeight = COMPOSITE_LAYOUT.composite.height;
            const compositeBounds = [[0, 0], [compositeHeight, compositeWidth]];
            
            // Add image overlays for each area (inverted Y coordinates for Leaflet)
            const wildAreaBounds = [
                [compositeHeight - (COMPOSITE_LAYOUT.wild_area.y + COMPOSITE_LAYOUT.wild_area.height), COMPOSITE_LAYOUT.wild_area.x],
                [compositeHeight - COMPOSITE_LAYOUT.wild_area.y, 
                 COMPOSITE_LAYOUT.wild_area.x + COMPOSITE_LAYOUT.wild_area.width]
            ];
            
            const ioaBounds = [
                [compositeHeight - (COMPOSITE_LAYOUT.isle_of_armor.y + COMPOSITE_LAYOUT.isle_of_armor.height), COMPOSITE_LAYOUT.isle_of_armor.x],
                [compositeHeight - COMPOSITE_LAYOUT.isle_of_armor.y,
                 COMPOSITE_LAYOUT.isle_of_armor.x + COMPOSITE_LAYOUT.isle_of_armor.width]
            ];
            
            const ctBounds = [
                [compositeHeight - (COMPOSITE_LAYOUT.crown_tundra.y + COMPOSITE_LAYOUT.crown_tundra.height), COMPOSITE_LAYOUT.crown_tundra.x],
                [compositeHeight - COMPOSITE_LAYOUT.crown_tundra.y,
                 COMPOSITE_LAYOUT.crown_tundra.x + COMPOSITE_LAYOUT.crown_tundra.width]
            ];
            
            // Add overlays
            L.imageOverlay('images/map.png', wildAreaBounds).addTo(compositeMap);
            L.imageOverlay('images/map_ioa.png', ioaBounds).addTo(compositeMap);
            L.imageOverlay('images/map_tc.png', ctBounds).addTo(compositeMap);
            
            // Fit map to composite bounds
            compositeMap.fitBounds(compositeBounds);
            
            // Add markers for all dens
            denData.forEach((den, index) => {
                const coords = transformDenCoordinates(den);
                const areaName = getAreaName(den.location);
                
                const marker = L.circleMarker([coords.y, coords.x], {
                    radius: 8,
                    fillColor: '#ff0000',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(compositeMap);
                
                marker.denData = den;
                marker.areaName = areaName;
                allMarkers.push(marker);
                
                marker.on('click', function() {
                    const denNumber = den.den_number || (index + 1);
                    openModal(createDenPopup(den, index), `Den #${denNumber} (${areaName})`, den, index);
                });
            });
            
            // Force map resize after initialization
            setTimeout(() => {
                compositeMap.invalidateSize();
            }, 100);
        }
        
        // Keep all existing modal, filtering, and Pokemon functions
        function createPokemonSprite(pokemon) {
            const speciesId = pokemon.species;
            
            let spriteNumber = speciesId;
            if (pokemon.gigantamax && gmaxMapping[speciesId]) {
                spriteNumber = gmaxMapping[speciesId];
            }
            
            const exclusiveClass = pokemon.exclusiveVersion === 1 ? 'sword-exclusive' : 
                                 pokemon.exclusiveVersion === 2 ? 'shield-exclusive' : '';
            
            function formatRanks(minRank, maxRank) {
                const displayMin = minRank + 1;
                const displayMax = maxRank + 1;
                return displayMin === displayMax ? `${displayMin}☆` : `${displayMin}☆-${displayMax}☆`;
            }
            
            let rankDisplay = '';
            
            if (pokemon.swordRanks && pokemon.shieldRanks) {
                const swordRanksStr = formatRanks(pokemon.swordRanks.min, pokemon.swordRanks.max);
                const shieldRanksStr = formatRanks(pokemon.shieldRanks.min, pokemon.shieldRanks.max);
                
                if (swordRanksStr === shieldRanksStr) {
                    rankDisplay = swordRanksStr;
                } else {
                    rankDisplay = `S:${swordRanksStr} Sh:${shieldRanksStr}`;
                }
            } else if (pokemon.swordRanks) {
                rankDisplay = formatRanks(pokemon.swordRanks.min, pokemon.swordRanks.max);
            } else if (pokemon.shieldRanks) {
                rankDisplay = formatRanks(pokemon.shieldRanks.min, pokemon.shieldRanks.max);
            }
            
            const matchesFilter = pokemonMatchesCurrentFilters(pokemon);
            const highlightClass = matchesFilter ? 'filter-match' : '';
            
            const pokemonInstanceId = `pokemon-${speciesId}-${pokemon.altForm || 0}-${pokemon.gigantamax ? 'gmax' : 'normal'}-${Date.now()}-${Math.random()}`;
            
            return `
                <div class="pokemon-sprite-container">
                    <div class="sprite-${spriteNumber} pokemon-sprite ${exclusiveClass} clickable-sprite" 
                         onclick="openPokemonDetailModal(${JSON.stringify(pokemon).replace(/"/g, '&quot;')})"
                         data-pokemon-id="${pokemonInstanceId}"></div>
                    <div class="rank-display ${highlightClass}">${rankDisplay}</div>
                </div>
            `;
        }
        
        function createPokemonGrid(pokemonList, title) {
            if (!pokemonList || pokemonList.length === 0) {
                return `<div class="popup-section"><h3 style="margin: 10px 0 15px 0; color: #333;">${title}</h3><p>No Pokemon data available</p></div>`;
            }
            
            const sprites = pokemonList.map(p => createPokemonSprite(p)).join('');
            
            return `
                <div class="popup-section">
                    <h3 style="margin: 10px 0 15px 0; color: #333; border-bottom: 2px solid #e0e0e0; padding-bottom: 8px;">
                        ${title}
                    </h3>
                    <div class="pokemon-grid">${sprites}</div>
                </div>
            `;
        }
        
        function createDenPopup(den, index) {
            const commonPokemon = getPokemonFromBothVersions(den.common_pool);
            const rarePokemon = getPokemonFromBothVersions(den.rare_pool);
            
            return `
                <div style="font-size: 16px;">
                    ${createPokemonGrid(commonPokemon, `Common Pool (#${den.common_pool})`)}
                    ${createPokemonGrid(rarePokemon, `Rare Pool (#${den.rare_pool})`)}
                </div>
            `;
        }
        
        // Modal functions
        function openModal(content, title = 'Raid Den', den = null, index = null) {
            currentModalDen = den;
            currentModalIndex = index;
            
            document.getElementById('modalContent').innerHTML = `
                <div class="modal-header">
                    <h3 class="modal-title">${title}</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-scroll-container">
                    ${content}
                </div>
            `;
            document.body.classList.add('modal-open');
            document.getElementById('denModal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('denModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            currentModalDen = null;
            currentModalIndex = null;
        }
        
        function openPokemonDetailModal(pokemon) {
            const speciesId = pokemon.species;
            const pokemonName = capitalizePokemonName(pokemonNames[speciesId] || `Pokemon #${speciesId}`);
            const content = createPokemonDetailContent(pokemon);
            
            document.getElementById('pokemonDetailContent').innerHTML = `
                <div class="modal-header">
                    <h3 class="modal-title">${pokemonName}</h3>
                    <button class="modal-close" onclick="closePokemonDetailModal()">&times;</button>
                </div>
                <div class="modal-scroll-container">
                    ${content}
                </div>
            `;
            document.body.classList.add('modal-open');
            document.getElementById('pokemonDetailModal').style.display = 'flex';
        }
        
        function closePokemonDetailModal() {
            document.getElementById('pokemonDetailModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }
        
        function createPokemonDetailContent(pokemon) {
            const speciesId = pokemon.species;
            
            let spriteNumber = speciesId;
            if (pokemon.gigantamax && gmaxMapping[speciesId]) {
                spriteNumber = gmaxMapping[speciesId];
            }
            
            const versionText = pokemon.exclusiveVersion === 1 ? 'Sword Only' : 
                              pokemon.exclusiveVersion === 2 ? 'Shield Only' : 
                              'Both Versions';
            const versionColor = pokemon.exclusiveVersion === 1 ? '#0075BE' : 
                               pokemon.exclusiveVersion === 2 ? '#C62D42' : '#666';
            
            function formatProbabilities(probArray, versionName) {
                if (!probArray || !Array.isArray(probArray)) return '';
                const probText = probArray
                    .map((prob, index) => ({ star: index + 1, prob }))
                    .filter(item => item.prob > 0)
                    .map(item => `${item.star}☆: ${item.prob}%`)
                    .join(', ');
                return probText ? `<strong>${versionName}:</strong> ${probText}` : '';
            }
            
            let sections = [];
            
            let basicInfo = [];
            if (pokemon.altForm && pokemon.altForm > 0) {
                basicInfo.push(`<p>Alternative Form: ${pokemon.altForm}</p>`);
            }
            if (pokemon.gigantamax) {
                basicInfo.push(`<p>Gigantamax Form Available</p>`);
            }
            if (pokemon.gender === 1) {
                basicInfo.push(`<p>Gender: Male Only</p>`);
            } else if (pokemon.gender === 2) {
                basicInfo.push(`<p>Gender: Female Only</p>`);
            } else {
                basicInfo.push(`<p>Gender: Any</p>`);
            }
            if (pokemon.flawlessIVs) {
                basicInfo.push(`<p>Guaranteed Perfect IVs: ${pokemon.flawlessIVs}</p>`);
            }
            
            if (basicInfo.length > 0) {
                sections.push(`
                    <div class="pokemon-detail-section">
                        <h4>Basic Information</h4>
                        ${basicInfo.join('')}
                    </div>
                `);
            }
            
            let probInfo = [];
            const swordProbs = formatProbabilities(pokemon.swordProbabilities, 'Sword');
            const shieldProbs = formatProbabilities(pokemon.shieldProbabilities, 'Shield');
            
            if (swordProbs) probInfo.push(`<p>${swordProbs}</p>`);
            if (shieldProbs) probInfo.push(`<p>${shieldProbs}</p>`);
            
            if (probInfo.length > 0) {
                sections.push(`
                    <div class="pokemon-detail-section">
                        <h4>Spawn Probabilities</h4>
                        ${probInfo.join('')}
                    </div>
                `);
            }
            
            return `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="sprite-${spriteNumber} pokemon-detail-sprite" style="margin: 0 auto 15px auto;"></div>
                    <p style="margin: 0; font-size: 16px; color: #666;">#${speciesId}</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px; color: ${versionColor}; font-weight: bold;">${versionText}</p>
                </div>
                <div class="pokemon-detail-info">
                    ${sections.join('')}
                </div>
            `;
        }
        
        function pokemonMatchesCurrentFilters(pokemon) {
            const hasFilters = currentFilter || selectedStars.size > 0;
            if (!hasFilters) {
                return false;
            }
            
            const pokemonId = currentFilter ? parseInt(currentFilter) : null;
            const hasStarFilter = selectedStars.size > 0;
            
            let pokemonMatches = true;
            if (pokemonId) {
                pokemonMatches = pokemon.species === pokemonId;
            }
            
            let starMatches = true;
            if (hasStarFilter) {
                const selectedRanks = Array.from(selectedStars).map(star => star - 1);
                let pokemonRanks = [];
                
                if (pokemon.swordRanks && typeof pokemon.swordRanks === 'object') {
                    for (let rank = pokemon.swordRanks.min; rank <= pokemon.swordRanks.max; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                if (pokemon.shieldRanks && typeof pokemon.shieldRanks === 'object') {
                    for (let rank = pokemon.shieldRanks.min; rank <= pokemon.shieldRanks.max; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                
                if (pokemon.minRank !== undefined && pokemon.maxRank !== undefined) {
                    for (let rank = pokemon.minRank; rank <= pokemon.maxRank; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                
                starMatches = selectedRanks.some(selectedRank => pokemonRanks.includes(selectedRank));
            }
            
            return pokemonMatches && starMatches;
        }
        
        // Pokemon filter setup
        function setupPokemonFilter() {
            const searchInput = document.getElementById('pokemonSearch');
            const dropdown = document.getElementById('pokemonDropdown');
            
            pokemonList = Object.entries(pokemonNames).map(([id, name]) => ({
                id: parseInt(id),
                name: name,
                searchText: `${name.toLowerCase()}`
            }));
            
            pokemonList.sort((a, b) => a.name.localeCompare(b.name));
            
            searchInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                if (query.length > 0) {
                    showFilteredPokemon(query);
                } else {
                    hideDropdown();
                    if (currentFilter) {
                        currentFilter = '';
                        applyFilters();
                    }
                }
            });
            
            searchInput.addEventListener('blur', function() {
                setTimeout(() => hideDropdown(), 150);
            });
            
            searchInput.addEventListener('focus', function() {
                const query = this.value.toLowerCase().trim();
                showFilteredPokemon(query);
            });
            
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    hideDropdown();
                    if (currentFilter) {
                        currentFilter = '';
                        applyFilters();
                    }
                }
            });
        }
        
        function capitalizePokemonName(name) {
            return name.split(' ').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
            ).join(' ');
        }
        
        function showFilteredPokemon(query) {
            const dropdown = document.getElementById('pokemonDropdown');
            let filteredPokemon;
            
            if (query.length === 0) {
                filteredPokemon = pokemonList;
            } else {
                filteredPokemon = pokemonList.filter(pokemon => 
                    pokemon.searchText.includes(query) || 
                    pokemon.id.toString() === query
                );
            }
            
            if (filteredPokemon.length > 0) {
                dropdown.innerHTML = filteredPokemon.map(pokemon => {
                    const capitalizedName = capitalizePokemonName(pokemon.name);
                    return `<div class="pokemon-search-item" onclick="selectPokemon(${pokemon.id}, '${pokemon.name.replace(/'/g, "\\'")}')">
                        ${capitalizedName}
                    </div>`;
                }).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.innerHTML = '<div class="pokemon-search-item">No Pokemon found</div>';
                dropdown.style.display = 'block';
            }
        }
        
        function hideDropdown() {
            document.getElementById('pokemonDropdown').style.display = 'none';
        }
        
        function selectPokemon(pokemonId, pokemonName) {
            const searchInput = document.getElementById('pokemonSearch');
            searchInput.value = capitalizePokemonName(pokemonName);
            hideDropdown();
            currentFilter = pokemonId.toString();
            applyFilters();
        }
        
        // Star filter functions
        function toggleStarFilter(star) {
            const button = document.querySelector(`[data-star="${star}"]`);
            
            if (selectedStars.has(star)) {
                selectedStars.delete(star);
                button.classList.remove('active');
            } else {
                selectedStars.add(star);
                button.classList.add('active');
            }
            
            applyFilters();
        }
        
        function clearStarFilters() {
            selectedStars.clear();
            document.querySelectorAll('.star-button').forEach(button => {
                button.classList.remove('active');
            });
            applyFilters();
        }
        
        function applyFilters() {
            filterDensByFilters();
            refreshModalIfOpen();
        }
        
        function filterDensByFilters() {
            const pokemonId = currentFilter ? parseInt(currentFilter) : null;
            const hasStarFilter = selectedStars.size > 0;
            
            if (!pokemonId && !hasStarFilter) {
                allMarkers.forEach(marker => {
                    marker.setStyle({
                        fillColor: '#ff0000',
                        color: '#ffffff',
                        opacity: 1,
                        fillOpacity: 0.8,
                        weight: 2
                    });
                });
                updateFilterStatus({total: allMarkers.length}, allMarkers.length);
                return;
            }
            
            let counts = { common: 0, rare: 0, both: 0, total: 0 };
            const pokemonName = pokemonId ? pokemonNames[pokemonId] : null;
            
            allMarkers.forEach(marker => {
                const den = marker.denData;
                let denMatches = false;
                let pokemonResult = null;
                
                if (pokemonId && hasStarFilter) {
                    denMatches = denContainsPokemonAtStarRanks(den, pokemonId, selectedStars);
                    if (denMatches) {
                        pokemonResult = denContainsPokemon(den, pokemonId);
                    }
                } else if (pokemonId && !hasStarFilter) {
                    pokemonResult = denContainsPokemon(den, pokemonId);
                    denMatches = pokemonResult.hasPokemon;
                } else if (!pokemonId && hasStarFilter) {
                    denMatches = denContainsStarRanks(den, selectedStars);
                }
                
                if (denMatches) {
                    counts.total++;
                    let fillColor, borderColor;
                    
                    if (pokemonResult && pokemonResult.hasPokemon) {
                        switch (pokemonResult.poolType) {
                        case 'common':
                                fillColor = '#ff0000';
                            borderColor = '#cc0000';
                            counts.common++;
                            break;
                        case 'rare':
                                fillColor = '#8b00ff';
                            borderColor = '#6600cc';
                            counts.rare++;
                            break;
                        case 'both':
                                fillColor = '#ff0000';
                                borderColor = '#8b00ff';
                            counts.both++;
                            break;
                        }
                    } else {
                        fillColor = '#ff0000';
                        borderColor = '#cc0000';
                    }
                    
                    marker.setStyle({
                        fillColor: fillColor,
                        color: borderColor,
                        opacity: 1,
                        fillOpacity: 0.9,
                        weight: 3
                    });
                } else {
                    marker.setStyle({
                        fillColor: '#cccccc',
                        color: '#999999',
                        opacity: 0.3,
                        fillOpacity: 0.2,
                        weight: 1
                    });
                }
            });
            
            updateFilterStatus(counts, allMarkers.length, pokemonName, selectedStars);
        }
        
        function denContainsPokemon(den, pokemonId) {
            const commonPokemon = getPokemonFromBothVersions(den.common_pool);
            const rarePokemon = getPokemonFromBothVersions(den.rare_pool);
            
            const inCommon = commonPokemon.some(pokemon => pokemon.species === pokemonId);
            const inRare = rarePokemon.some(pokemon => pokemon.species === pokemonId);
            
            return {
                hasPokemon: inCommon || inRare,
                inCommon: inCommon,
                inRare: inRare,
                poolType: inCommon && inRare ? 'both' : (inCommon ? 'common' : (inRare ? 'rare' : 'none'))
            };
        }
        
        function denContainsPokemonAtStarRanks(den, pokemonId, starSet) {
            const commonPokemon = getPokemonFromBothVersions(den.common_pool);
            const rarePokemon = getPokemonFromBothVersions(den.rare_pool);
            const allPokemon = [...commonPokemon, ...rarePokemon];
            
            const selectedRanks = Array.from(starSet).map(star => star - 1);
            
            const targetPokemon = allPokemon.filter(pokemon => pokemon.species === pokemonId);
            
            if (targetPokemon.length === 0) {
                return false;
            }
            
            for (let pokemon of targetPokemon) {
                let pokemonRanks = [];
                
                if (pokemon.swordRanks && typeof pokemon.swordRanks === 'object') {
                    for (let rank = pokemon.swordRanks.min; rank <= pokemon.swordRanks.max; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                if (pokemon.shieldRanks && typeof pokemon.shieldRanks === 'object') {
                    for (let rank = pokemon.shieldRanks.min; rank <= pokemon.shieldRanks.max; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                
                if (pokemon.minRank !== undefined && pokemon.maxRank !== undefined) {
                    for (let rank = pokemon.minRank; rank <= pokemon.maxRank; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                
                const hasMatch = selectedRanks.some(selectedRank => pokemonRanks.includes(selectedRank));
                
                if (hasMatch) {
                    return true;
                }
            }
            
            return false;
        }
        
        function denContainsStarRanks(den, starSet) {
            const commonPokemon = getPokemonFromBothVersions(den.common_pool);
            const rarePokemon = getPokemonFromBothVersions(den.rare_pool);
            const allPokemon = [...commonPokemon, ...rarePokemon];
            
            const selectedRanks = Array.from(starSet).map(star => star - 1);
            
            for (let pokemon of allPokemon) {
                let pokemonRanks = [];
                
                if (pokemon.swordRanks && typeof pokemon.swordRanks === 'object') {
                    for (let rank = pokemon.swordRanks.min; rank <= pokemon.swordRanks.max; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                if (pokemon.shieldRanks && typeof pokemon.shieldRanks === 'object') {
                    for (let rank = pokemon.shieldRanks.min; rank <= pokemon.shieldRanks.max; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                
                if (pokemon.minRank !== undefined && pokemon.maxRank !== undefined) {
                    for (let rank = pokemon.minRank; rank <= pokemon.maxRank; rank++) {
                        if (!pokemonRanks.includes(rank)) {
                            pokemonRanks.push(rank);
                        }
                    }
                }
                
                const hasMatch = selectedRanks.some(selectedRank => pokemonRanks.includes(selectedRank));
                if (hasMatch) {
                    return true;
                }
            }
            
            return false;
        }
        
        function updateFilterStatus(counts, total, pokemonName = null, starSet = null) {
            const statusElement = document.getElementById('filterStatus');
            
            if (pokemonName || (starSet && starSet.size > 0)) {
                const totalCount = (typeof counts === 'object' && counts.total !== undefined) ? counts.total : counts;
                let statusText = `Showing ${totalCount} of ${total} dens`;
                
                const filters = [];
                if (pokemonName) {
                    filters.push(`<strong>${pokemonName}</strong>`);
                }
                if (starSet && starSet.size > 0) {
                    const starText = Array.from(starSet).sort((a, b) => a - b).map(s => `${s}☆`).join(', ');
                    filters.push(`<strong>${starText}</strong>`);
                }
                
                if (filters.length > 0) {
                    statusText += ` with ${filters.join(' and ')}`;
                }
                
                statusElement.innerHTML = statusText;
                statusElement.style.display = 'block';
            } else {
                statusElement.style.display = 'none';
            }
        }
        
        function refreshModalIfOpen() {
            if (currentModalDen && currentModalIndex !== null && 
                document.getElementById('denModal').style.display === 'flex') {
                const content = createDenPopup(currentModalDen, currentModalIndex);
                const areaName = getAreaName(currentModalDen.location);
                const denNumber = currentModalDen.denNumber || (currentModalIndex + 1);
                const title = `Den #${denNumber} (${areaName})`;
                
                document.getElementById('modalContent').innerHTML = `
                    <div class="modal-header">
                        <h3 class="modal-title">${title}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-scroll-container">
                        ${content}
                    </div>
                `;
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('denModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            document.getElementById('pokemonDetailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePokemonDetailModal();
                }
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                    closePokemonDetailModal();
                }
            });
            
            document.addEventListener('click', function(e) {
                const modalContent = e.target.closest('.modal-content');
                const pokemonContent = e.target.closest('.pokemon-detail-content');
                if (modalContent || pokemonContent) {
                    e.stopPropagation();
                }
            });
        });
        
        // Window resize handler
        window.addEventListener('resize', function() {
            if (compositeMap) {
                                    setTimeout(() => {
                    compositeMap.invalidateSize();
                                    }, 100);
            }
        });
    </script>
</body>
</html> 